{% extends "event/base.html" %}
{% block content %}

<div class="container mt-5">

    <div class="row justify-content-center">
        <div class="col-md-8">

            <!-- Event Card -->
            <div class="card shadow-lg mb-4">
                {% if event.event_image %}
                    <img src="{{ event.event_image.url }}" class="card-img-top" alt="{{ event.event_name }}">
                {% endif %}
                <div class="card-body">
                    <h2 class="card-title">{{ event.event_name }}</h2>
                    <p class="card-text">{{ event.event_description }}</p>

                    {% if event.event_time %}
                        <p class="text-muted"><strong>Date & Time: </strong>{{ event.event_time|date:"F j, Y, g:i A" }}</p>
                    {% endif %}

                    <p class="text-muted"><strong>Created by:</strong> {{ event.user.username }}</p>

                    {% if request.user.is_authenticated %}
                        <button id="rsvp-btn" class="btn btn-primary">RSVP</button>
                    {% else %}
                        <p class="text-warning">Please <a href="{% url 'login' %}">log in</a> to RSVP.</p>
                    {% endif %}
                </div>
            </div>

            <!-- RSVP List -->
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5>People who RSVP'd</h5>
                </div>
                <ul class="list-group list-group-flush" id="rsvp-list">
                    {% if rsvps %}
                        {% for rsvp in rsvps %}
                            <li class="list-group-item">{{ rsvp.user.username }}</li>
                        {% endfor %}
                    {% else %}
                        <li class="list-group-item">No one has RSVP'd yet.</li>
                    {% endif %}
                </ul>
            </div>

        </div>
    </div>

</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // Utility: read a cookie value by name.
    // We use this to fetch the CSRF token stored in the 'csrftoken' cookie
    // so we can include it in the AJAX request header.
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Cookie string format is 'name=value'
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Click handler for the RSVP button
    // - reads CSRF token from cookie
    // - issues POST to RSVP endpoint
    // - updates the RSVP list on success or shows an error message
    $('#rsvp-btn').click(function(){
        // Get csrf token from cookies (Django sets this cookie when rendering forms)
        const csrftoken = getCookie('csrftoken');

        $.ajax({
            // URL: the rsvp endpoint for this event generated by Django's url
            url: "{% url 'rsvp_event' event.id %}",
            type: 'POST',
            // Include CSRF token in the header so Django accepts the POST
            headers: {'X-CSRFToken': csrftoken},

            // On success: backend returns JSON like {status: 'success', username: '...'}
            success: function(data) {
                if (data.status === 'success') {
                    // Append the username to the RSVP list and disable the button
                    $('#rsvp-list').append('<li class="list-group-item">' + data.username + '</li>');
                    $('#rsvp-btn').prop('disabled', true).text('RSVP\'d');
                } else if (data.status === 'exists') {
                    // User already RSVPd
                    alert('You have already RSVP\'d');
                } else if (data.message) {
                    // Any custom message from server (e.g., event not found)
                    alert(data.message);
                }
            },

            // On error: attempt to show a useful message from the server, otherwise show a generic one
            error: function(xhr) {
                let msg = 'Error RSVPing';
                try {
                    const resp = JSON.parse(xhr.responseText);
                    if (resp && resp.message) msg = resp.message;
                } catch (e) {
                    // If response is not JSON, keep generic message
                }
                alert(msg);
            }
        });
    });
</script>

{% endblock %}